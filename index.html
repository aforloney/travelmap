
<!DOCTYPE html>
<meta charset="utf-8">
<body>
  <script src="src/d3.v3.min.js"></script>
  <script src="src/topojson.v1.min.js"></script>
  <script src="src/datamaps.all.min.js"></script>
  <script src="src/exif.js"></script>
  <script src="src/load-image.all.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.js"></script>
  
  <div id="myContainer" style="display:inline-block">
    <div id="container" style="position: relative; width: 500px; height: 200px; display:inline-block"></div>
    <div id="msgContainer" style="display:inline-block; position: absolute; top 100px; left: 500px;">
        <div id="msg"></div>
    </div>
    <!-- This is the area to upload files and/or introduce drag and drop functionality-->
    <div id="fileUploader" style="display:inline-block; position: absolute; top: 100px; left: 500px">
     <form action="pending.php" method="POST" enctype="multipart/form-data">
         <input type="file" mutiple="multiple" id="uploadImg" name="upload" style="display:block"></input>
         <div id="address_input" style="display:inline-block">
            <span style="float:left">Address </span>
            <input id="address" type="text" style="width:500px;float:right"></input>
          </div>
          <div id="comment_input" style="display:inline-block">
            <span style="float:left">Comment</span>
            <input id="blurb" type="text" style="width:500px;float:right"></input>
          </div>
            <!-- <button id="OK" style="display:block">Okay</button> -->
            <div id="form_footer" style="display:inline-block">
              <input type="submit"></input>
            </div>
      </form>

    </div>
      <div>Pending Images</div>
      <div id ="preview" style="margin: 5px; width:500px"></div>

  </div>  


  <script>

    function get_pending() {
      var user_id = 1;

        $.ajax({
                type: 'GET',
                url: 'userinfo.php',
                data: {id: user_id},
                success: function(data) {
                  console.log("data: %O", JSON.parse(data));
                  var obj = JSON.parse(data);
                  var msg = document.getElementById("msg");
                  msg.innerHTML = "Number of pending images: " + obj.rows;
                }
        });
    }

    $(document).ready(function() {
        get_pending();
    });

     var states = {
        'Arizona': 'AZ',
        'Alabama': 'AL',
        'Alaska': 'AK',
        'Arizona': 'AZ',
        'Arkansas': 'AR',
        'California': 'CA',
        'Colorado': 'CO',
        'Connecticut': 'CT',
        'Delaware': 'DE',
        'Florida': 'FL',
        'Georgia': 'GA',
        'Hawaii': 'HI',
        'Idaho': 'ID',
        'Illinois': 'IL',
        'Indiana': 'IN',
        'Iowa': 'IA',
        'Kansas': 'KS',
        'Kentucky': 'KY',
        'Kentucky': 'KY',
        'Louisiana': 'LA',
        'Maine': 'ME',
        'Maryland': 'MD',
        'Massachusetts': 'MA',
        'Michigan': 'MI',
        'Minnesota': 'MN',
        'Mississippi': 'MS',
        'Missouri': 'MO',
        'Montana': 'MT',
        'Nebraska': 'NE',
        'Nevada': 'NV',
        'New Hampshire': 'NH',
        'New Jersey': 'NJ',
        'New Mexico': 'NM',
        'New York': 'NY',
        'North Carolina': 'NC',
        'North Dakota': 'ND',
        'Ohio': 'OH',
        'Oklahoma': 'OK',
        'Oregon': 'OR',
        'Pennsylvania': 'PA',
        'Rhode Island': 'RI',
        'South Carolina': 'SC',
        'South Dakota': 'SD',
        'Tennessee': 'TN',
        'Texas': 'TX',
        'Utah': 'UT',
        'Vermont': 'VT',
        'Virginia': 'VA',
        'Washington': 'WA',
        'West Virginia': 'WV',
        'Wisconsin': 'WI',
        'Wyoming': 'WY',
    };


    var okay_btn = document.getElementById('OK');
    //okay_btn.addEventListener("click", submit_pending, false);

    function submit_pending() {
        var addressEle = document.getElementById("address");
        var file = document.getElementById("uploadImg");
        var blurb = document.getElementById("blurb");

        console.log("Trying to submit pending data...");

        if (address.value != '') {
          console.log("Address: ", address.value);
          var that = this.dataset;
          var blurbValue = blurb.value;

          $.ajax({
                  type: 'POST',
                  url: 'pending.php',
                  data: {
                          user_id: 1,
                          filepath: file.value,
                          lng: that.long,
                          lat: that.lat,
                          address: that.address,
                          city: that.city,
                          state: that.state,
                          postal: that.postal,
                          country: that.country,
                          blurb: blurbValue,
                          dt: that.date
                  },
                  success: function(data) {
                      var obj = JSON.parse(data);
                      console.log("obj %O", obj);
                      if (obj.status == "success") {
                        var msg = document.getElementById("msg");
                        var address = document.getElementById("address");
                        var blurb = document.getElementById("blurb");

                        get_pending();

                        // reset input fields,
                        address.value = '';
                        blurb.value = '';

                    }
                 }
            });
        }
    }

     var fileEle = document.getElementById("uploadImg");
     fileEle.addEventListener("change", getExifData, false);

     function getExifData() {
        var files = this.files;

        for (var i = 0; i < files.length; i++) {
          EXIF.getData(files[i], function() {
                  var exifData = EXIF.getAllTags(this);
                  var addressEle = document.getElementById("address");
                  var okay_btn = document.getElementById("OK");

                  // check whether we have actual data within the IMG,
                  if (Object.keys(exifData).length > 0) {

                    var latRef  = exifData['GPSLatitudeRef'];
                    var latList = exifData['GPSLatitude'];
                    var lat = DMS(latList);

                    if (latRef == "S") lat = lat * -1;

                    var lngRef  = exifData['GPSLongitudeRef'];
                    var lngList = exifData['GPSLongitude'];
                    var lng = DMS(lngList); 

                    if (lngRef == "W") lng = lng * -1;

                    $.ajax({
                          type: 'GET',
                          url: 'http://nominatim.openstreetmap.org/reverse',
                          data: {
                                  'format': 'json',
                                  'lat' : lat,
                                  'lon': lng
                          },
                          success: function(data) {
                              var address = data.address;
                              var state = address.state;
                              /*
                                  data.address = {
                                      city:"Providence",
                                      country:"United States of America",
                                      country_code:"us",
                                      county:"Providence County",
                                      house_number:"112",
                                      postcode:"02906",
                                      road:"4th Street",
                                      state:"Rhode Island"
                                  };
                              */

                              console.log("updating the map for", state);

                              var mapData = {};
                              mapData[states[state]] = { 'fillKey' : 'VISITED' };
                              map.updateChoropleth(mapData);

                              addressEle.value = data.display_name;

                              okay_btn.dataset['long'] = lng;
                              okay_btn.dataset['lat'] = lat,
                              okay_btn.dataset['address'] = data.display_name;
                              okay_btn.dataset['city'] = data.address.city;
                              okay_btn.dataset['state'] = data.address.state;
                              okay_btn.dataset['postal'] = data.address.postcode;
                              okay_btn.dataset['country'] = data.address.country_code;
                              okay_btn.dataset['date'] = new Date();
                         }
                    });

                          loadImage(
                              this,
                              function (img) {
                                  document.getElementById("preview").appendChild(img);
                              },
                              {orientation: true,
                               maxWidth: 200,
                               maxHeight: 200} // Options
                          );
                  }
                  else {
                        addressEle.innerHTML = "Unable to read GPS data.";
                  }
              });
          }
      }

     function DMS(coords) {
        var deg = coords[0],
            mins = coords[1],
            sec = coords[2];
        return ( deg + ( (mins / 60.) + (sec / 3600.) ) );
     }

     var map = new Datamap({
        scope: 'usa',
        //projection: 'orthographic',
        element: document.getElementById('container'),
        responsive: true,
        height: 300,
        fills: {
          'VISITED': 'blue',
          defaultFill: 'black'
        },
        data: {}
     });

     map.legend();

     /*     *************************************** TESTING CODE
     var states = ['RI', 'MA', 'WA', 'FL', 'ME', 'VT', 'NY', 'MD'];
     var fills = ['<=25', '<=10'];

     var displayStates = window.setInterval(function() {
        //var state = states[Math.floor(Math.random() * states.length)];
        var state = states.pop();
        if (state != undefined) {
          var m = document.getElementById("msg");
          var data = {};
          var idx = Math.floor(Math.random() * fills.length);
          data[state] = { 'fillKey' : fills[idx],
                           'images': (idx == 0 ? 'Up to 10' : 'Up to 25') };
          map.updateChoropleth(data);

        }
        else {
          console.log("No more states to display...");
          clearInterval(displayStates);
        }
      }, 1000);
      */
     </script>
</body>