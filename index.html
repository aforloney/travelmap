
<!DOCTYPE html>
<meta charset="utf-8">
<body>
  <script src="src/d3.v3.min.js"></script>
  <script src="src/topojson.v1.min.js"></script>
  <script src="src/datamaps.all.min.js"></script>
  <script src="src/exif.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.js"></script>
  
  <div id="myContainer" style="display:inline-block">
    <div id="container" style="position: relative; width: 500px; height: 200px; display:inline-block"></div>
    <div id="msgContainer" style="display:inline-block; position: absolute; top 100px; left: 500px; ">
        <div id="msg"></div>
    </div>

    <!-- This is the area to upload files and/or introduce drag and drop functionality-->
    <div id="fileUploader" style="display:inline-block; position: absolute; top: 100px; left: 500px">
      <input type="file" id="uploadImg" style="display:inline-block"></input>
      <div id="address"></div>
    </div>
  </div>


  <script>

     var states = {
        'Arizona': 'AZ',
        'Alabama': 'AL',
        'Alaska': 'AK',
        'Arizona': 'AZ',
        'Arkansas': 'AR',
        'California': 'CA',
        'Colorado': 'CO',
        'Connecticut': 'CT',
        'Delaware': 'DE',
        'Florida': 'FL',
        'Georgia': 'GA',
        'Hawaii': 'HI',
        'Idaho': 'ID',
        'Illinois': 'IL',
        'Indiana': 'IN',
        'Iowa': 'IA',
        'Kansas': 'KS',
        'Kentucky': 'KY',
        'Kentucky': 'KY',
        'Louisiana': 'LA',
        'Maine': 'ME',
        'Maryland': 'MD',
        'Massachusetts': 'MA',
        'Michigan': 'MI',
        'Minnesota': 'MN',
        'Mississippi': 'MS',
        'Missouri': 'MO',
        'Montana': 'MT',
        'Nebraska': 'NE',
        'Nevada': 'NV',
        'New Hampshire': 'NH',
        'New Jersey': 'NJ',
        'New Mexico': 'NM',
        'New York': 'NY',
        'North Carolina': 'NC',
        'North Dakota': 'ND',
        'Ohio': 'OH',
        'Oklahoma': 'OK',
        'Oregon': 'OR',
        'Pennsylvania': 'PA',
        'Rhode Island': 'RI',
        'South Carolina': 'SC',
        'South Dakota': 'SD',
        'Tennessee': 'TN',
        'Texas': 'TX',
        'Utah': 'UT',
        'Vermont': 'VT',
        'Virginia': 'VA',
        'Washington': 'WA',
        'West Virginia': 'WV',
        'Wisconsin': 'WI',
        'Wyoming': 'WY',
    };


     var fileEle = document.getElementById("uploadImg");
     fileEle.addEventListener("change", getExifData, false);

     function getExifData() {
        var files = this.files;

        for (var i = 0; i < files.length; i++) {
          EXIF.getData(files[i], function() {
                  var exifData = EXIF.getAllTags(this);
                  var addressEle = document.getElementById("address");

                  // check whether we have actual data within the IMG,
                  if (Object.keys(exifData).length > 0) {

                    var latRef  = exifData['GPSLatitudeRef'];
                    var latList = exifData['GPSLatitude'];
                    var lat = DMS(latList);

                    if (latRef == "S") lat = lat * -1;

                    var lngRef  = exifData['GPSLongitudeRef'];
                    var lngList = exifData['GPSLongitude'];
                    var lng = DMS(lngList); 

                    if (lngRef == "W") lng = lng * -1;

                    $.ajax({
                          type: 'GET',
                          url: 'http://nominatim.openstreetmap.org/reverse',
                          data: {
                                  'format': 'json',
                                  'lat' : lat,
                                  'lon': lng
                          },
                          success: function(data) {
                              var address = data.address;
                              var state = address.state;
                              /*
                                  data.address = {
                                      city:"Providence",
                                      country:"United States of America",
                                      country_code:"us",
                                      county:"Providence County",
                                      house_number:"112",
                                      postcode:"02906",
                                      road:"4th Street",
                                      state:"Rhode Island"
                                  };
                              */

                              console.log("updating the map for", state);

                              var mapData = {};
                              mapData[states[state]] = { 'fillKey' : 'VISITED' };
                              map.updateChoropleth(mapData);

                              addressEle.innerHTML = data.display_name;
                          }
                    });
                  }
                  else {
                        addressEle.innerHTML = "Unable to read GPS data.";
                  }
              });
          }
      }

     function DMS(coords) {
        var deg = coords[0],
            mins = coords[1],
            sec = coords[2];
        return ( deg + ( (mins / 60.) + (sec / 3600.) ) );
     }

     var map = new Datamap({
      scope: 'usa',
      //projection: 'orthographic',
      element: document.getElementById('container'),
      responsive: true,
      height: 300,
      fills: {
        'VISITED': 'blue',
        defaultFill: 'black'
      },
      data: {}
     });

     map.legend();

     /*     *************************************** TESTING CODE
     var states = ['RI', 'MA', 'WA', 'FL', 'ME', 'VT', 'NY', 'MD'];
     var fills = ['<=25', '<=10'];

     var displayStates = window.setInterval(function() {
        //var state = states[Math.floor(Math.random() * states.length)];
        var state = states.pop();
        if (state != undefined) {
          var m = document.getElementById("msg");
          var data = {};
          var idx = Math.floor(Math.random() * fills.length);
          data[state] = { 'fillKey' : fills[idx],
                           'images': (idx == 0 ? 'Up to 10' : 'Up to 25') };
          map.updateChoropleth(data);

        }
        else {
          console.log("No more states to display...");
          clearInterval(displayStates);
        }
      }, 1000);
      */
     </script>
</body>